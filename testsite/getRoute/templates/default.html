{% extends "multigtfs/base.html" %}
{% load staticfiles %}
{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin="">
<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
    integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
    crossorigin="">
    </script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script src="{% static 'javascript/validatecsrf.js' %}"></script>
<script src="{% static 'javascript/getRoute.js' %}"></script>
{% endblock %}

{% block page_title%}Default Map{%endblock%}

{% block nav_home_active_class %} class="active"{% endblock %}

{% block page_top_content_elem %}
Test to include a Leaflet.js map into a django project
{% endblock %}

{% block page_middle_content %}
<p class="text-center">
    <div id="map">
    </div>
</p>
<p class="text-center">
    <a href="{% url 'feed_list' %}" class="btn btn-primary" role="button">Feed List</a>
    <a href="{% url 'admin:index' %}" class="btn btn-primary" role="button">Admin</a>

    <form action="{% url 'getlocation' %} " method="POST" id="post-form">
        {% csrf_token %}
        <!-- <div class="fieldWrapper" id="the_post">
            {{ form.text }}
        </div> -->
        <select name="toFind">
            <option value="stop">stops</option>
            <option value="shape">shapes</option>
            <option value="trip">trips</option>
        </select>
        <input type="submit" value="Post" class="tiny button">
        <div id="results"></div> <!-- Shape data printed here-->
    </form>
</p>
{% endblock %}

{% block body_script %}

<script>
    // Initialise Leaflet Map
    var startCoords = [51.8983, -8.4726] // Cork City Centre
    var typeString;
    var coords; // Coords passed in ewkd type
    var markers = [];
    var layers = [];
    var editableLayers;
    var toFind;
    var route;

    // Load map after page
    window.addEventListener('DOMContentLoaded', getLocation(), false);

    function getLocation() {
        // Attempts to get the location of the user
        if (navigator.geolocation) {
            return navigator.geolocation.getCurrentPosition(setViewPosition);
        } else {
            console.log("Geolocation is not supported by this browser.");
            main();
        }
    };

    function setViewPosition(position) {
        startCoords = [position.coords.latitude, position.coords.longitude];
        main();
    };

    function main() {
        // Initialise Map with Tiles and controls
        baseMap = L.map('map').setView([startCoords[0], startCoords[1]], 14);

        // Initialise Tiles
        // var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     maxZoom: 19,
        //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        // });

        var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            // 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        OpenStreetMap_Mapnik.addTo(baseMap)


        // Initialise the FeatureGroup to store editable layers
        editableLayers = new L.FeatureGroup();
        baseMap.addLayer(editableLayers);

        var drawControlOptions = {
            position: 'topright',
            draw: {
                polygon: {
                    allowIntersection: false, // Restricts shapes to simple polygons
                    drawError: {
                        color: 'red', // Color the shape will turn when intersects
                        message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                    },
                    shapeOptions: {
                        color: '#97009c'
                    }
                },
                // disable toolbar item by setting it to false
                polyline: true,

                circle: false, // Turns off this drawing tool
                rectangle: false,
                marker: false,
                circlemarker: false,
            },
            edit: {
                featureGroup: editableLayers, //REQUIRED!!
                remove: true,
                edit: false,
            }
        };

        // Initialise the draw control and pass it the FeatureGroup of editable layers
        var drawControl = new L.Control.Draw(drawControlOptions);
        baseMap.addControl(drawControl);

        baseMap.on('draw:created', function (e) {
            var type = e.layerType,
                layer = e.layer;

            if (type === 'polygon') {
                // console.log(e.layer._latlngs);
                typeString = 'POLYGON'
            }

            editableLayers.addLayer(layer);
            coords = e.layer.getLatLngs()

            var par = document.createElement('p');
            var node = document.createTextNode(typeString + '\n: ' + JSON.stringify(coords));
            par.appendChild(node);

            var element = document.getElementById('results');
            element.appendChild(par);
            layers.push(e);
        });

        // baseMap.on('draw:edited', function (f) {
        //     // Clear all the markers and redraw the ones inside the oayer editted
        //     for (let i = 0; i < markers.length; i++) {
        //         let marker = markers[i];
        //         baseMap.removeLayer(marker);
        //         // basemap.removeLayer(markerLayer);
        //     };
        //     markers=[];
        //     coords = f.layers.getLayers()[0].getLatLngs();
        //     create_post();
        // });
    }
</script>

<script>
    // Validate User and send Ajax
    mainVali()

    // Submit event caller
    $('#post-form').on('submit', function (event) {
        event.preventDefault();

        // Name of the data we want back
        toFind = $('#post-form').serializeArray()[1].value;

        create_post();
    });

    // Event handler to create POST request
    function create_post() {
        $.ajax({
            url: "{% url 'getlocation' %}", // the endpoint
            type: "POST", // http method
            data: { type: typeString, latlng: JSON.stringify(coords), toFind: toFind }, // data sent with the post request

            // handle a successful response
            success: function (json) {
                // Response Fields shape, toFind, geom,count
                var response = json;
                console.log("success"); // another sanity check
                switch (response.toFind) {
                    case 'stop':
                        add_markers(response);
                        break;
                        // console.log(response);
                    case 'shape':
                        add_shape(response);
                        break;
                    case 'trip':
                        console.log(response);
                        break;
                }
                // if (response.toFind === 'stop') {
                //     add_markers(response);
                // }
                // else if (response.toFind === 'shape') {
                //     add_shape(response);
                // }
                // else if (response.toFind === 'trip') {
                //     console.log(response)
                // }
                // else if
            },

            // handle a non-successful response
            error: function (xhr, errmsg, err) {
                // $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                //     " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };
    function add_shape(response) {
        if (response.count > 500) {
            console.log('Over 500 shapes to render!');
        }
        for (let i = 0; i < response.count; i++) {
            let route = new DrawRoute(baseMap);
            // as WKT
            editableLayers.addLayer(route.makeLine(response.geom[i][1], 'wkt', 0.7, route.getColour()));

            //AS GEOJSON
            // editableLayers.addLayer(route.makeLine(response.geom[i], 'geojson', 0.7, route.getColour()));
        }
    }
    function add_markers(response) {
        if (response.count > 100) {
            // $(results).html("<div class='alert-box alert radius' data-alert> Too Many Stops in this area!</div>")
            console.log('Over 100 Stops');
        }
        // log the returned json to the console

        // console.log(response.count);
        // console.log(response.geom);
        // console.log(response.shape);

        // Add all stops to the map
        for (let i = 0; i < response.count; i++) {

            let route = new DrawRoute(baseMap);
            let currentStopCoords = response.geom[i][1];
            let currentStopTitle = response.geom[i][0]

            currentStopCoords = route.fixCoordsWKT(currentStopCoords);
            
            var marker = L.marker(currentStopCoords[0], { title: currentStopTitle, riseOnHover: true });
            // var marker = L.marker([currentStopCoords[1], currentStopCoords[0]], { title: currentStopCoords[2], riseOnHover: true });
            marker.on('click', function (e) {
                var layer = e.target;
                console.log(layer.options);
            });
            // marker.addTo(markerLayer);
            editableLayers.addLayer(marker);
            // markers.push(marker);
        }
    }
</script>
{% endblock %}